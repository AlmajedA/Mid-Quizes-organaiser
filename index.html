<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web 3 and metamask</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="flex w-screen h-screen justify-center items-center">
    <div id='main-div' class="flex-col space-y-2 justify-center items-center">
        <button id='loginButton' onclick="" class="mx-auto rounded-md p-2 bg-pink-500 text-white">
            Login with MetaMask
        </button>
        <p id='userWallet' class='text-lg text-gray-600 my-2'></p>


    </div>

    <script>
        window.userWalletAddress = null
        const loginButton = document.getElementById('loginButton')
        const userWallet = document.getElementById('userWallet')


        function toggleButton() {
            if (!window.ethereum) {
                loginButton.innerText = 'MetaMask is not installed'
                loginButton.classList.remove('bg-pink-500', 'text-white')
                loginButton.classList.add('bg-gray-500', 'text-gray-100', 'cursor-not-allowed')
                return false
            }

            loginButton.addEventListener('click', loginWithMetaMask)
        }

        async function loginWithMetaMask() {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' }).catch((e) => {
                console.error(e.message)
                return
            })
            if (!accounts) { return }

            window.userWalletAddress = accounts[accounts.length - 1];
            userWallet.innerText = window.userWalletAddress
            loginButton.innerText = 'Sign out of MetaMask'

            //added
            generateForm();
            const form = document.getElementById('form');

            //payment
            form.addEventListener('submit', (event) => {
                sendTransaction(event);
                event.preventDefault();
            })

            loginButton.removeEventListener('click', loginWithMetaMask)
            setTimeout(() => {
                loginButton.addEventListener('click', signOutOfMetaMask)
            }, 200)
        }

        function signOutOfMetaMask() {
            window.userWalletAddress = null
            userWallet.innerText = ''
            loginButton.innerText = 'Sign in with MetaMask'

            //added
            removeForm();

            loginButton.removeEventListener('click', signOutOfMetaMask)
            setTimeout(() => {
                loginButton.addEventListener('click', loginWithMetaMask)
            }, 200)
        }

        function sendTransaction(event) {
            const data = document.querySelectorAll('#form input');
            const amount = parseInt(data[0].value) * 1000000000000000000;
            const sendTo = data[1].value;
            const hexString = amount.toString(16);


            // console.log('0x' + '0'.repeat(16 - hexString.length) + hexString);
            // console.log(sendTo);


            window.userWalletAddress
            ethereum.request({
                method: 'eth_sendTransaction',
                params: [
                    {
                        from: window.userWalletAddress,
                        to: sendTo,
                        value: '0x' + hexString,

                    },
                ],
            })
                .then((txHash) => console.log(txHash))
                .catch((error) => console.error);

        }

        function generateForm() {

            const mainDiv = document.getElementById('main-div');
            const form = document.createElement('form');
            const div1 = document.createElement('div');
            const div2 = document.createElement('div');
            const label1 = document.createElement('label');
            const input1 = document.createElement('input');
            const label2 = document.createElement('label');
            const input2 = document.createElement('input');
            const submit = document.createElement('button');
            form.appendChild(div1);
            form.appendChild(div2);

            form.id = 'form';
            div1.classList.add('p-0.5');
            div2.classList.add('p-0.5');

            // edit the first label1
            label1.for = 'amount';
            label1.innerText = 'Send amount: ';
            // edit the first input
            input1.type = 'text';
            input1.id = 'amount';
            input1.classList.add('bg-gray-50', 'border-gray-300', 'text-gray-900', 'text-sm', 'rounded-lg', 'focus:ring-blue-500', 'focus:border-blue-500', 'p-2.5', 'dark:bg-gray-700');
            input1.placeholder = '2 ETH';
            input1.required = true;
            form.children[0].appendChild(label1);
            form.children[0].appendChild(input1);

            // edit the second label
            label2.for = 'to';
            label2.innerText = 'Transfer  to: ';
            // edit the second input
            input2.type = 'text';
            input2.id = 'to';
            input2.classList.add('bg-gray-50', 'border-gray-300', 'text-gray-900', 'text-sm', 'rounded-lg', 'focus:ring-blue-500', 'focus:border-blue-500', 'p-2.5', 'dark:bg-gray-700');
            input2.placeholder = 'Account address';
            input2.required = true;
            form.children[1].appendChild(label2);
            form.children[1].appendChild(input2);

            //submition

            submit.innerText = 'Pay';
            submit.type = 'submit';
            submit.classList.add('mx-auto', 'rounded-md', 'p-2', 'bg-pink-500', 'text-white');

            form.appendChild(submit);

            mainDiv.appendChild(form);


        }

        function removeForm() {
            const form = document.getElementById('form');
            form.parentNode.removeChild(form);
        }


        window.addEventListener('DOMContentLoaded', (event) => {
            toggleButton();
        });

    </script>
</body>

</html>